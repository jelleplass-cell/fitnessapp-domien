// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============ ENUMS ============

enum Role {
  SUPER_ADMIN
  INSTRUCTOR
  CLIENT
}

enum Difficulty {
  BEGINNER
  INTERMEDIATE
  ADVANCED
}

enum Location {
  GYM
  HOME
  OUTDOOR
}

enum Language {
  NL
  EN
  FR
}

enum EquipmentType {
  MACHINE     // Fitness toestellen (leg press, cable machine, etc.)
  ACCESSORY   // Losse materialen (dumbbells, kettlebells, bands, etc.)
}

// ============ USER & AUTH ============

model User {
  id             String    @id @default(cuid())
  email          String    @unique
  password       String    // hashed with bcrypt
  name           String
  firstName      String?
  lastName       String?
  phone          String?
  avatarUrl      String?
  role           Role      @default(CLIENT)
  language       Language  @default(NL)
  resetToken     String?
  resetExpires   DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  // Address fields
  street         String?
  houseNumber    String?
  postalCode     String?
  city           String?
  country        String?   @default("Nederland")
  dateOfBirth    DateTime?
  notes          String?   // Instructor notes about this client

  // Instructor relation (for clients)
  instructorId   String?
  instructor     User?     @relation("InstructorClients", fields: [instructorId], references: [id], onDelete: SetNull)
  clients        User[]    @relation("InstructorClients")

  // Relations
  createdExercises      Exercise[]
  createdPrograms       Program[]
  createdCategories     Category[]
  clientPrograms        ClientProgram[]
  sessions              Session[]
  scheduledPrograms     ScheduledProgram[]
  notifications         Notification[]
  communityPosts        CommunityPost[]
  postComments          PostComment[]
  postLikes             PostLike[]     @relation("PostLikes")
  commentLikes          CommentLike[]  @relation("CommentLikes")
  eventRegistrations    EventRegistration[]
  createdEvents         Event[]
  modules               InstructorModules?
  instructorProfile     InstructorProfile?
  communitySettings     CommunitySettings?
  givenKudos            ActivityKudos[] @relation("GivenKudos")
  createdCommunities    Community[]     @relation("CreatedCommunities")
  communityMemberships  CommunityMember[]
  createdEquipment      Equipment[]

  @@index([instructorId])
}

// ============ EXERCISES ============

model Exercise {
  id                String    @id @default(cuid())
  name              String
  description       String?
  instructions      String?   // detailed step-by-step instructions
  youtubeUrl        String?
  imageUrl          String?
  audioUrl          String?
  durationMinutes   Int       // estimated duration for full exercise
  sets              Int
  reps              Int?
  holdSeconds       Int?
  restSeconds       Int       @default(60) // rest between sets
  caloriesPerSet    Int?      // estimated calories burned per set
  requiresEquipment Boolean   @default(false)
  equipment         String?
  locations         String[]  @default(["GYM"]) // GYM, HOME, OUTDOOR - supports multiple
  muscleGroups      String?   // e.g., "chest,shoulders,triceps"
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relations
  creatorId         String
  creator           User             @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  programItems      ProgramItem[]
  clientExerciseNotes ClientExerciseNote[]
  clientProgramItems  ClientProgramItem[]
  exerciseEquipment   ExerciseEquipment[]

  @@index([creatorId])
}

// ============ EQUIPMENT / MATERIALEN ============

model Equipment {
  id          String        @id @default(cuid())
  name        String
  description String?
  type        EquipmentType @default(ACCESSORY)
  images      String?       // JSON array of image URLs: ["url1", "url2"]
  steps       String?       // JSON array of usage steps: ["Step 1", "Step 2"]
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  // Relations
  creatorId            String
  creator              User               @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  exercises            ExerciseEquipment[]
  alternativeForLinks  ExerciseEquipment[] @relation("AlternativeEquipment")

  @@index([creatorId])
  @@index([type])
}

model ExerciseEquipment {
  id               String     @id @default(cuid())
  order            Int        @default(0) // display order
  alternativeText  String?    // free-text alternative description (e.g. "Gebruik een gewone fiets buiten")

  // Relations
  exerciseId       String
  exercise         Exercise   @relation(fields: [exerciseId], references: [id], onDelete: Cascade)
  equipmentId      String
  equipment        Equipment  @relation(fields: [equipmentId], references: [id], onDelete: Cascade)
  alternativeEquipmentId String?
  alternativeEquipment   Equipment? @relation("AlternativeEquipment", fields: [alternativeEquipmentId], references: [id], onDelete: SetNull)

  @@unique([exerciseId, equipmentId])
  @@index([exerciseId])
  @@index([equipmentId])
}

// ============ CATEGORIES ============

model Category {
  id          String   @id @default(cuid())
  name        String
  description String?
  color       String   @default("#3B82F6")
  icon        String?  // icon name for UI
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  creatorId   String
  creator     User      @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  programs    Program[]

  @@index([creatorId])
}

// ============ PROGRAMS ============

model Program {
  id               String     @id @default(cuid())
  name             String
  description      String?
  shortDescription String?    // for library cards
  imageUrl         String?
  difficulty       Difficulty @default(BEGINNER)
  location         Location   @default(GYM)
  durationMinutes  Int?       // total estimated duration
  caloriesBurn     Int?       // estimated calories burned
  equipmentNeeded  String?    // comma-separated list
  isPublic         Boolean    @default(false) // visible in library for all clients
  isArchived       Boolean    @default(false)
  createdAt        DateTime   @default(now())
  updatedAt        DateTime   @updatedAt

  // Relations
  creatorId        String
  creator          User            @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  categories       Category[]      // many-to-many
  items            ProgramItem[]
  clientPrograms   ClientProgram[]

  @@index([creatorId])
  @@index([isPublic])
}

model ProgramItem {
  id             String   @id @default(cuid())
  order          Int
  customSets     Int?     // override exercise default
  customReps     Int?     // override exercise default
  customDuration Int?     // override exercise default (minutes)
  notes          String?  // instructor notes for this exercise in this program

  // Relations
  programId      String
  program        Program  @relation(fields: [programId], references: [id], onDelete: Cascade)
  exerciseId     String
  exercise       Exercise @relation(fields: [exerciseId], references: [id], onDelete: Cascade)

  @@index([programId])
}

// ============ CLIENT PROGRAMS ============

model ClientProgram {
  id          String    @id @default(cuid())
  order       Int       @default(0)
  startDate   DateTime?
  endDate     DateTime? // NEW: end date for the period
  isActive    Boolean   @default(true)
  assignedBy  String?   // "INSTRUCTOR" or "SELF" or "LIBRARY"
  createdAt   DateTime  @default(now())

  // Relations
  clientId            String
  client              User                   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  programId           String
  program             Program                @relation(fields: [programId], references: [id], onDelete: Cascade)
  sessions            Session[]
  scheduledPrograms   ScheduledProgram[]
  exerciseNotes       ClientExerciseNote[]
  customItems         ClientProgramItem[]

  @@unique([clientId, programId])
  @@index([clientId])
}

// Custom notes per exercise per client program
model ClientExerciseNote {
  id              String   @id @default(cuid())
  note            String   // custom instruction for this client
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  clientProgramId String
  clientProgram   ClientProgram @relation(fields: [clientProgramId], references: [id], onDelete: Cascade)
  exerciseId      String
  exercise        Exercise      @relation(fields: [exerciseId], references: [id], onDelete: Cascade)

  @@unique([clientProgramId, exerciseId])
  @@index([clientProgramId])
}

// ============ SESSIONS & TRACKING ============

model Session {
  id              String    @id @default(cuid())
  startedAt       DateTime  @default(now())
  finishedAt      DateTime?
  status          String    @default("IN_PROGRESS") // IN_PROGRESS, COMPLETED, CANCELLED
  caloriesBurned  Int?
  durationMinutes Int?

  // Relations
  clientProgramId String
  clientProgram   ClientProgram @relation(fields: [clientProgramId], references: [id], onDelete: Cascade)
  userId          String
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  completedItems  SessionItem[]
  kudos           ActivityKudos[]

  @@index([userId])
}

model SessionItem {
  id            String   @id @default(cuid())
  completedAt   DateTime @default(now())
  skipped       Boolean  @default(false)
  actualSets    Int?
  actualReps    Int?
  notes         String?  // client can add notes during workout

  // Relations
  sessionId     String
  session       Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  programItemId String

  @@index([sessionId])
}

// ============ SCHEDULING ============

model ScheduledProgram {
  id            String   @id @default(cuid())
  scheduledDate DateTime
  scheduledTime String?  // e.g., "09:00"
  completed     Boolean  @default(false)
  notes         String?
  createdAt     DateTime @default(now())

  // Relations
  clientId        String
  client          User          @relation(fields: [clientId], references: [id], onDelete: Cascade)
  clientProgramId String
  clientProgram   ClientProgram @relation(fields: [clientProgramId], references: [id], onDelete: Cascade)

  @@index([clientId, scheduledDate])
}

// ============ NOTIFICATIONS ============

model Notification {
  id        String   @id @default(cuid())
  type      String   // PROGRAM_ASSIGNED, NEW_POST, EVENT_REMINDER, etc.
  title     String
  message   String
  link      String?  // URL to navigate to
  read      Boolean  @default(false)
  createdAt DateTime @default(now())

  // Relations
  userId    String
  user      User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, read])
}

// ============ COMMUNITY ============

// Community groups - instructors can create multiple communities (General, Mastermind, VIP, etc.)
model Community {
  id              String   @id @default(cuid())
  name            String   // e.g., "Algemeen", "Mastermind", "VIP"
  description     String?
  color           String   @default("#3B82F6") // For visual distinction
  icon            String?  // Icon name
  isDefault       Boolean  @default(false) // The main/general community everyone has access to
  isArchived      Boolean  @default(false)
  clientsCanPost  Boolean  @default(false) // Whether clients can create posts in this community
  order           Int      @default(0) // For ordering in sidebar
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  creatorId    String
  creator      User              @relation("CreatedCommunities", fields: [creatorId], references: [id], onDelete: Cascade)
  members      CommunityMember[]
  posts        CommunityPost[]

  @@index([creatorId])
  @@index([isDefault])
}

// Community membership - which clients have access to which communities
model CommunityMember {
  id           String   @id @default(cuid())
  joinedAt     DateTime @default(now())

  // Relations
  communityId  String
  community    Community @relation(fields: [communityId], references: [id], onDelete: Cascade)
  userId       String
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([communityId, userId])
  @@index([communityId])
  @@index([userId])
}

model CommunityPost {
  id           String    @id @default(cuid())
  title        String?
  content      String
  imageUrl     String?
  videoUrl     String?
  audioUrl     String?
  isPinned     Boolean   @default(false)
  publishAt    DateTime? // Scheduled post - if set and in future, post is not visible yet
  isPublished  Boolean   @default(true) // For draft/published state
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  // Relations
  authorId     String
  author       User          @relation(fields: [authorId], references: [id], onDelete: Cascade)
  comments     PostComment[]
  likes        PostLike[]

  // Community this post belongs to (null = legacy posts, shown in default community)
  communityId  String?
  community    Community?    @relation(fields: [communityId], references: [id], onDelete: Cascade)

  // Optional linked event
  eventId      String?  @unique
  event        Event?   @relation(fields: [eventId], references: [id], onDelete: SetNull)

  @@index([authorId])
  @@index([createdAt])
  @@index([publishAt])
  @@index([communityId])
}

model PostLike {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  // Relations
  postId    String
  post      CommunityPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  userId    String
  user      User          @relation("PostLikes", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([postId, userId])
  @@index([postId])
}

model PostComment {
  id              String   @id @default(cuid())
  content         String
  gifUrl          String?  // For GIF reactions
  attachmentUrl   String?  // For file attachments (images, docs, etc.)
  attachmentName  String?  // Original filename
  attachmentType  String?  // MIME type of attachment
  videoUrl        String?  // For video links (YouTube, Loom, etc.)
  linkUrl         String?  // For URL links
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  postId    String
  post      CommunityPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  authorId  String
  author    User          @relation(fields: [authorId], references: [id], onDelete: Cascade)

  // Nested replies
  parentId  String?
  parent    PostComment?  @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies   PostComment[] @relation("CommentReplies")

  // Likes
  likes     CommentLike[]

  @@index([postId])
  @@index([parentId])
}

model CommentLike {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  // Relations
  commentId String
  comment   PostComment @relation(fields: [commentId], references: [id], onDelete: Cascade)
  userId    String
  user      User        @relation("CommentLikes", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([commentId, userId])
  @@index([commentId])
}

// ============ EVENTS ============

enum EventType {
  TRAINING      // Physical training session (gym, outdoor, etc.)
  ONLINE        // Online coaching call, webinar, etc.
  WORKSHOP      // In-person workshop
  OTHER         // Other type of event
}

model Event {
  id               String    @id @default(cuid())
  title            String
  description      String?
  eventType        EventType @default(TRAINING)

  // Location details
  location         String?   // Physical location or "Online"
  locationDetails  String?   // Additional directions, parking info, etc.

  // Online event details
  meetingUrl       String?   // Zoom, Teams, Google Meet link
  meetingPlatform  String?   // "zoom", "teams", "meet", "other"

  // Media & attachments
  imageUrl         String?
  videoUrl         String?   // Promo video or introduction

  // Files/attachments (stored as JSON array)
  attachments      String?   // JSON: [{ name, url, type }]

  // Training-specific details
  equipment        String?   // Required equipment/materials
  difficulty       String?   // BEGINNER, INTERMEDIATE, ADVANCED

  // Scheduling
  startDate        DateTime
  endDate          DateTime?

  // Registration settings
  maxAttendees     Int?
  requiresRegistration Boolean @default(true)  // false = just add to calendar
  registrationDeadlineHours Int @default(6)    // Hours before event to close registration
  allowWaitlist    Boolean   @default(true)

  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  // Relations
  creatorId        String
  creator          User               @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  registrations    EventRegistration[]
  communityPost    CommunityPost?

  @@index([creatorId])
  @@index([startDate])
  @@index([eventType])
}

model EventRegistration {
  id         String   @id @default(cuid())
  status     String   @default("REGISTERED") // REGISTERED, WAITLIST, CANCELLED, ATTENDED
  isWaitlist Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  eventId    String
  event      Event @relation(fields: [eventId], references: [id], onDelete: Cascade)
  userId     String
  user       User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([eventId, userId])
  @@index([eventId, status])
}

// ============ INSTRUCTOR MODULES ============

model InstructorModules {
  id              String   @id @default(cuid())
  fitnessEnabled  Boolean  @default(true)  // Programs & Exercises
  communityEnabled Boolean @default(true)  // Community posts
  eventsEnabled   Boolean  @default(true)  // Events management
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  instructorId    String   @unique
  instructor      User     @relation(fields: [instructorId], references: [id], onDelete: Cascade)
}

// ============ INSTRUCTOR PROFILE ============

model InstructorProfile {
  id              String   @id @default(cuid())
  bio             String?  // About the instructor
  expertise       String?  // e.g., "Krachttraining, HIIT, Voedingsadvies"
  trainingTypes   String?  // e.g., "Personal Training, Groepslessen, Online Coaching"
  certifications  String?  // e.g., "NASM-CPT, Voedingscoach niveau 4"
  yearsExperience Int?
  photoUrl        String?  // Profile photo
  coverImageUrl   String?  // Cover/banner image
  instagramUrl    String?
  facebookUrl     String?
  linkedinUrl     String?
  websiteUrl      String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  instructorId    String   @unique
  instructor      User     @relation(fields: [instructorId], references: [id], onDelete: Cascade)
}

// ============ COMMUNITY SETTINGS ============

model CommunitySettings {
  id              String   @id @default(cuid())
  name            String   @default("FitTrack Pro") // Community name
  description     String?  // Community description
  logoUrl         String?  // Custom logo
  primaryColor    String   @default("#3B82F6") // Brand color
  welcomeMessage  String?  // Message shown to new clients
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  instructorId    String   @unique
  instructor      User     @relation(fields: [instructorId], references: [id], onDelete: Cascade)
}

// ============ ACTIVITY KUDOS ============

model ActivityKudos {
  id          String   @id @default(cuid())
  emoji       String   @default("üí™") // e.g., "üí™", "üî•", "‚≠ê", "üëè"
  message     String?  // Optional short message from instructor
  createdAt   DateTime @default(now())

  // Relations
  sessionId   String
  session     Session  @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  instructorId String
  instructor  User     @relation("GivenKudos", fields: [instructorId], references: [id], onDelete: Cascade)

  @@unique([sessionId, instructorId]) // One kudos per instructor per session
  @@index([sessionId])
}

// ============ CLIENT PROGRAM CUSTOMIZATION ============

model ClientProgramItem {
  id              String   @id @default(cuid())
  order           Int
  customSets      Int?     // Override from template
  customReps      Int?     // Override from template
  customDuration  Int?     // Override from template (minutes)
  notes           String?  // Custom notes for this client
  isAdded         Boolean  @default(false) // True if added specifically for this client (not from template)
  isRemoved       Boolean  @default(false) // True if removed for this client (hide from template)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  clientProgramId String
  clientProgram   ClientProgram @relation(fields: [clientProgramId], references: [id], onDelete: Cascade)
  exerciseId      String
  exercise        Exercise      @relation(fields: [exerciseId], references: [id], onDelete: Cascade)

  @@unique([clientProgramId, exerciseId])
  @@index([clientProgramId])
}
